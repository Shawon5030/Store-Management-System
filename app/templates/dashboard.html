<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Management Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#5b63f6',
            secondary: '#4352d8',
            light: '#f9fafc',
            dark: '#1c1f2d',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-50 font-sans text-gray-800">
  <!-- Navbar -->
  {% include "navbar/nav.html" %}

  <!-- Django Messages -->
  <div class="container mx-auto mt-3 px-4">
    {% if messages %}
      {% for message in messages %}
        <div class="alert flex items-center justify-between p-4 mb-4 rounded-lg border 
          {% if message.tags == 'success' %} bg-green-50 border-green-200 text-green-800
          {% elif message.tags == 'error' %} bg-red-50 border-red-200 text-red-800
          {% elif message.tags == 'warning' %} bg-yellow-50 border-yellow-200 text-yellow-800
          {% else %} bg-blue-50 border-blue-200 text-blue-800 {% endif %}">
          <div class="flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            {{ message }}
          </div>
          <button type="button" class="text-lg font-semibold hover:text-gray-700 transition-colors">&times;</button>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <!-- Total Received -->
      <div
        class="bg-white text-gray-800 rounded-xl drop-shadow-xl border-b-4 border-purple-600 hover:shadow-xl transition-all duration-300 hover:-translate-y-1 p-6">
        <i class="fas fa-box-open text-2xl text-purple-600 mb-3 block"></i>
        <h3 class="text-2xl font-bold mb-1" id="total-received">{{ total_received }}</h3>
        <p class="text-gray-600 font-medium">Total Received</p>
      </div>

      <!-- Distributed -->
      <div
        class="bg-white text-gray-800 rounded-xl drop-shadow-xl border-b-4 border-pink-500 hover:drop-shadow-2xl transition-all duration-300 hover:-translate-y-1 p-6">
        <i class="fas fa-truck text-2xl text-pink-500 mb-3 block"></i>
        <h3 class="text-2xl font-bold mb-1" id="total-distributed">{{ total_distributed }}</h3>
        <p class="text-gray-600 font-medium">Distributed</p>
      </div>

      <!-- Remaining -->
      <div
        class="bg-white text-gray-800 rounded-xl drop-shadow-xl border-b-4 border-cyan-500 hover:drop-shadow-2xl transition-all duration-300 hover:-translate-y-1 p-6">
        <i class="fas fa-warehouse text-2xl text-cyan-500 mb-3 block"></i>
        <h3 class="text-2xl font-bold mb-1" id="total-remaining">{{ total_remaining }}</h3>
        <p class="text-gray-600 font-medium">Remaining</p>
      </div>

      <!-- Total Value -->
      <div
        class="bg-white text-gray-800 rounded-xl drop-shadow-xl border-b-4 border-green-500 hover:drop-shadow-2xl transition-all duration-300 hover:-translate-y-1 p-6">
        <i class="fas fa-dollar-sign text-2xl text-green-500 mb-3 block"></i>
        <h3 class="text-2xl font-bold mb-1" id="total-value">${{ total_value }}</h3>
        <p class="text-gray-600 font-medium">Total Value</p>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Bar Chart -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-4 sm:p-6">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-semibold text-gray-800">Remaining vs Distributed Products</h4>
        </div>
        <div class="w-full h-64 sm:h-80 lg:h-96">
          <canvas id="barChart"></canvas>
        </div>
      </div>

      <!-- Pie Chart -->
      <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-semibold text-gray-800">Product-wise Stock</h4>
        </div>
        <div class="w-full h-64 sm:h-80 lg:h-96">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Product Table -->
    <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6">
      <div class="mb-4">
        <h4 class="text-lg font-semibold text-gray-800">Product Inventory</h4>
      </div>
      <div class="overflow-x-auto">
        <table id="productTable" class="w-full min-w-full">
          <thead>
            <tr class="bg-gray-100 text-gray-600 uppercase text-xs sm:text-sm">
              <th class="px-3 py-3 text-left font-semibold">Serial Number</th>
              <th class="px-3 py-3 text-left font-semibold">Product Name</th>
              <th class="px-3 py-3 text-left font-semibold">MRR Number</th>
              <th class="px-3 py-3 text-left font-semibold">Date</th>
              <th class="px-3 py-3 text-left font-semibold">Total Received</th>
              <th class="px-3 py-3 text-left font-semibold">Distributed</th>
              <th class="px-3 py-3 text-left font-semibold">Remaining</th>
              <th class="px-3 py-3 text-left font-semibold">Unit Price</th>
              <th class="px-3 py-3 text-left font-semibold">Total Price</th>
            </tr>
          </thead>
          <tbody class="text-gray-700 text-sm">
            {% for product in products %}
            <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200">
              <td class="px-3 py-3 whitespace-nowrap">{{ product.serial_number }}</td>
              <td class="px-3 py-3">{{ product.product_name }}</td>
              <td class="px-3 py-3 whitespace-nowrap">{{ product.mrr_number }}</td>
              <td class="px-3 py-3 whitespace-nowrap">{{ product.date }}</td>
              <td class="px-3 py-3 whitespace-nowrap">{{ product.total_received }}</td>
              <td class="px-3 py-3 whitespace-nowrap">{{ product.distributed }}</td>
              <td class="px-3 py-3 whitespace-nowrap">{{ product.remaining }}</td>
              <td class="px-3 py-3 whitespace-nowrap">${{ product.unit_price }}</td>
              <td class="px-3 py-3 whitespace-nowrap">${{ product.total_price }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

  <script>
    let barChartInstance = null;
    let pieChartInstance = null;
    let dataTableInstance = null;

    $(document).ready(function () {
      initializeDataTable();
      initializeCharts();
      
      // Close alert functionality
      $('.alert button').on('click', function() {
        $(this).closest('.alert').fadeOut();
      });
    });

    function initializeDataTable() {
      if (dataTableInstance) dataTableInstance.destroy();

      dataTableInstance = $("#productTable").DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        language: { 
          search: "_INPUT_", 
          searchPlaceholder: "Search products...",
          lengthMenu: "Show _MENU_ entries",
          info: "Showing _START_ to _END_ of _TOTAL_ entries",
          paginate: {
            previous: "‹",
            next: "›"
          }
        },
        dom: '<"flex flex-col lg:flex-row justify-between items-center mb-4"<"mb-2 lg:mb-0"l><"mb-2 lg:mb-0"f>><"overflow-x-auto"t><"flex flex-col lg:flex-row justify-between items-center mt-4"<"mb-2 lg:mb-0"i><"mb-2 lg:mb-0"p>>',
        deferRender: true,
        scrollCollapse: true,
        processing: true,
        autoWidth: false,
        columnDefs: [
          { responsivePriority: 1, targets: 0 }, // Serial Number
          { responsivePriority: 1, targets: 1 }, // Product Name
          { responsivePriority: 2, targets: -1 } // Total Price
        ]
      });
    }

    function initializeCharts() {
      if (barChartInstance) barChartInstance.destroy();
      if (pieChartInstance) pieChartInstance.destroy();

      const productNames = {{ product_names|safe }};
      const remainingData = {{ remaining_data|safe }};
      const distributedData = {{ distributed_data|safe }};

      // Bar Chart
      const barCtx = document.getElementById("barChart").getContext("2d");
      barChartInstance = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: productNames,
          datasets: [
            {
              label: "Remaining",
              data: remainingData,
              backgroundColor: "#4cc9f0",
              borderColor: "#4361ee",
              borderWidth: 1,
            },
            {
              label: "Distributed",
              data: distributedData,
              backgroundColor: "#f72585",
              borderColor: "#b5179e",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { 
            y: { 
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }, 
            x: { 
              grid: { display: false } 
            } 
          },
          plugins: { 
            legend: { 
              position: "top" 
            } 
          },
        },
      });

      // Pie Chart
      const pieCtx = document.getElementById("pieChart").getContext("2d");
      pieChartInstance = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: productNames,
          datasets: [
            {
              data: remainingData,
              backgroundColor: [
                "#4361ee","#3a0ca3","#4cc9f0",
                "#f72585","#7209b7","#4895ef",
                "#560bad","#b5179e","#f15bb5"
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              position: "bottom",
              labels: {
                boxWidth: 12,
                font: {
                  size: 11
                }
              }
            } 
          },
        },
      });
    }
  </script>
</body>
</html>
